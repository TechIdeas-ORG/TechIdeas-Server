<!doctype html>
<html>

<head>
    <title>Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="http://www.chartjs.org/dist/2.7.1/Chart.js"></script>
    <script src="http://www.chartjs.org/samples/latest/utils.js"></script>
    <link rel="stylesheet" href="CSS/style.css">
    <link rel="stylesheet" href="CSS/dashboard.css">
</head>

<body onload="obterDadosGrafico(), plotarGrafico(), consultarTudo()" onloadstart="CarregarBox()">
    <nav id="navbar">
        <div class="collapse" onclick="collapse()">
            <span class="material-symbols-rounded" id="collapse_text">
                chevron_left
            </span>
        </div>

        <div class="head">
            <img src="img/Logo.png">
            <h3>SMFP<br><span>Sistema de Mapeamento de Fluxo de Pessoas</span></h3>
        </div>
        <div class="menu">
            <ul>
                <li class="active"><a href="#">DashBoard</a></li>
                <li><a href="#">Mapa de Calor</a></li>
                <li><a href="#">Ambientes</a></li>
                <li><a href="#">Sensores</a></li>
                <li><a href="#">Configurações</a></li>
            </ul>
        </div>
        <div class="account">
            <span class="material-symbols-rounded">
                account_circle
            </span>
            <div class="perfil">
                <h3>Nome do Usuário</h3>
                <a href="#">Sair</a>
            </div>
        </div>
    </nav>

    <div class="page-title container">
        <h1>Dashboard Empresa</h1>
        <div></div>
    </div>

    <div class="areaGrafico container">
        <div class="divGraf1">
            <h1 id="chave1A">
                <select id="boxAmbiente" name="Ambiente" onchange="obterDadosGrafico()">

                    <option id="caixasBox" value="1">Ambiente 1</option>
                    <option id="caixasBox" value="2">
                        Ambiente 2
                    </option>

                </select>
            </h1>
            <br><br>
            <section style="width: 90%;" id="ambiente1">
                <canvas id="chave1"></canvas>
            </section>
        </div>

        <div class="divGraf2">
            <h1 id="chave1B">Geral</h1><br><br>
            <section style="width: 100%;" id="ambiente2">
                <canvas id="chave2"></canvas>
            </section>
        </div>
    </div>

    <div class="areaKPI container" id="dv_ambientes">
        <div class="kpi">
            <h4>Média de Fluxo da semana</h4>
            <span id="span_med_fluxo"></span>
        </div>
        <div class="kpi">
            <h4>Maior Fluxo</h4>
            <span id="span_max_fluxo"></span>
        </div>
        <div class="kpi">
            <h4>Aumento do Fluxo</h4>
            <span id="span_porcent_aum_fluxo"></span>
        </div>
    </div>

    <script>
        /*Dados de Testes*/
        const label_sem = ['Domingo', 'Segunda-Feira', 'Terça-Feira', 'Quarta-Feira', 'Quinta-Feira', 'Sexta-Feira', 'Sábado'];
        const dado_sem = [354, 540, 245, 424, 350, 348, 451];
        var soma = 0;
        var max_pos = 0;
        var somatotal = 0;
        var qtdeAmb = 0;
        var fluxoAmbs = [];

        for (var i = 0; i < dado_sem.length; i++) {
            var dado = dado_sem[i];
            soma += dado;
            if (dado > dado_sem[max_pos]) { max_pos = i }
        }

        span_med_fluxo.innerHTML = (soma / dado_sem.length).toFixed(2);
        span_max_fluxo.innerHTML = `${label_sem[max_pos]} teve o maior fluxo da semana com ${dado_sem[max_pos]} pontos`;
        var dif_dia1_maiorDia = dado_sem[max_pos] - dado_sem[0];
        /* 354 --- 100%
           186 --- X%
        */
        span_porcent_aum_fluxo.innerHTML = `O aumento foi de ${((dif_dia1_maiorDia * 100) / dado_sem[0]).toFixed(2)}% comparado ao primeiro dia da semana`;



        /* -- chave */
        var contextoChave = document.getElementById('chave1').getContext('2d');
        contextoChave.canvas.width = 1000;
        contextoChave.canvas.height = 300;
        /* definindo o tamano e a criacao do grafico*/
        var chave = new Chart(
            contextoChave,
            {
                type: 'bar',
                /*definindo o tipo do grafico*/
                data: {
                    labels: ['08:00', '09:00', '10:00', '11:00', '12:00', '13:00'],
                    datasets: [{
                        label: 'Chave', /*Nome do grafico*/
                        type: 'bar',
                        data: [10, 90, 10, 145, 122, 93],
                        borderColor: '#FFFFFF',/* cor da borda*/
                        backgroundColor: '#00ff43'/* cor do fundo do grafico*/
                    }]
                },
                options: {
                    legend: {
                        labels: {
                            fontColor: "#FFFFFF"/*cor da fonte do grafico*/
                        },
                    },
                    plugins: {
                        customCanvasBackgroundColor: {
                            color: 'LightGreen',
                        }
                    },
                    scales: {
                        xAxes: [{
                            distribution: 'series',
                            ticks: {
                                fontColor: 'FFF',
                                beginAtZero: true
                            }
                        }],
                        yAxes: [{
                            scaleLabel: {
                                fontColor: ['#fffff'],
                                display: true,
                                labelString: 'Chave'
                            },
                            ticks: {
                                fontColor: ['#fffff'],
                                beginAtZero: true
                            }
                        }]
                    },
                    animation: {
                        duration: 0
                    }
                }
            }
        );
        /* -- chave */
        /* var contextoChave = document.getElementById('chave2').getContext('2d');
         contextoChave.canvas.width = 1000;
         contextoChave.canvas.height = 300;
         let labels = [];
 
         var chave2 = new Chart(
             contextoChave,
             {
                 type: 'bar',
                 data: {
                     labels: ['08:00', '09:00', '10:00', '11:00', '12:00', '13:00'],
                     datasets: [{
                         label: 'Chave',
                         type: 'bar',
                         data: [10, 90, 10, 45, 122, 93],
                         borderColor: '#FFFFFF',
                         backgroundColor: '#00ff43'
                     }]
                 },
                 options: {
                     legend: {
                         labels: {
                             fontColor: "#FFFFFF"
                         },
                     },
                     plugins: {
                         customCanvasBackgroundColor: {
                             color: 'LightGreen',
                         }
                     },
                     scales: {
                         xAxes: [{
                             distribution: 'series',
                             ticks: {
                                 fontColor: 'FFF',
                                 beginAtZero: true
                             }
                         }],
                         yAxes: [{
                             scaleLabel: {
                                 fontColor: ['#fffff'],
                                 display: true,
                                 labelString: 'Chave'
                             },
                             ticks: {
                                 fontColor: ['#fffff'],
                                 beginAtZero: true
                             }
                         }]
                     },
                     animation: {
                         duration: 0
                     }
                 }
             }
         );*/

        window.onload = obterDadosGraficos();

        function obterDadosGraficos() {
            obterDadosGrafico(1)

        }
        function obterDadosGrafico(idSensor, dados, myChart) {

            const queryStr = window.location.search;
            const urlParam = new URLSearchParams(queryStr);
            var fkAmbiente = boxAmbiente.value;
            console.log(urlParam.get('idAmbiente'))
            if (urlParam.get('idAmbiente') == null) {
                fetch(`/ambiente/listar/${fkAmbiente}`, { cache: 'no-store' }).then(function (response) {
                    if (response.ok) {
                        console.log(response)
                        response.json().then(function (novoRegistro) {

                            console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                            console.log(`Dados atuais do gráfico:`);
                            console.log(dados);
                            let avisoCaptura = document.getElementById(`avisoCaptura${idSensor}`)
                            somatotal = 0;
                            
                            plotarGrafico(novoRegistro, fkAmbiente, somatotal);


                            /*if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
                                console.log("---------------------------------------------------------------")
                                console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                                avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                                console.log("Horário do novo dado capturado:")
                                console.log(novoRegistro[0].momento_grafico)
                                console.log("Horário do último dado capturado:")
                                console.log(dados.labels[dados.labels.length - 1])
                                console.log("---------------------------------------------------------------")
                            } else {
                                // tirando e colocando valores no gráfico
                                dados.labels.shift(); // apagar o primeiro
                                dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento
    
                                dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                                dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade
    
                                dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
                                dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura
    
                                myChart.update();
                            }*/

                            // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                            // proximaAtualizacao = setTimeout(() => atualizarGrafico(idSensor, dados, myChart), 2000);
                        });
                    } else {
                        console.error('Nenhum dado encontrado ou erro na API');
                        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                        //proximaAtualizacao = setTimeout(() => atualizarGrafico(idSensor, dados, myChart), 2000);
                    }
                })

                    .catch(function (error) {
                        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                    });
            }
            else {
                alert("opa")
            }


        }

        function plotarGrafico(resposta, fkAmbiente, soma) {

            let labels = [];
            let dados = {
                labels: labels,
                datasets: [{
                    label: 'fluxo',
                    data: [],
                    fill: false,
                    borderColor: '#FFFFFF',
                    backgroundColor: '#00ff43',
                    tension: 0.1
    
                }]
            };
            for (i = 0; i < resposta.length; i++) {
                var registro = resposta[i];
                labels.push(registro.horario + " minutos");
                console.log(registro.horario)
                console.log(dados.datasets[0].data)
                dados.datasets[0].data.push(registro.soma);
            }
            const config = {
                type: 'bar',
                data: dados,
            };
            let myChart = new Chart(
                document.getElementById(`chave2`),
                config
            );


            setTimeout(() => atualizarGrafico(fkAmbiente, dados, myChart), 2000);


        }
        function CarregarBox() {
            var fkUser = sessionStorage.ID_USUARIO;
            if (fkUser != null) {
                fetch(`/ambiente/consultaAmbiente/${fkUser}`, { cache: 'no-store' }).then(function (response) {
                    if (response.ok) {
                        console.log(response)
                        response.json().then(function (novoRegistro) {
                            console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);

                            console.log(novoRegistro)



                            boxAmbiente.innerHTML = ""

                            for (var i = 0; i < novoRegistro.length; i++) {
                                console.log("entrei no for")
                                boxAmbiente.innerHTML += ` <option id="caixasBox" value="${novoRegistro[i].idAmbiente}">${novoRegistro[i].nomeAmbiente}</option>`
                                dv_ambientes.innerHTML += `
                                    <div class="kpi">
                                        <h4 id="ambiente${i}">${novoRegistro[i].nomeAmbiente}</h4>
                                        <span id="span_qtde_amb${i}">${novoRegistro[i].soma}</span>
                                    </div>
                                `
                                qtdeAmb++;
                            }
                        });
                    } else {
                        console.error('Nenhum dado encontrado ou erro na API');
                        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                        //proximaAtualizacao = setTimeout(() => atualizarGrafico(idSensor, dados, myChart), 2000);
                    }
                })

                    .catch(function (error) {
                        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                    });
            }


        }
        CarregarBox();
        function atualizarGrafico(fkAmbiente, dados, myChart) {


            fetch(`/ambiente/listar/${fkAmbiente}`, { cache: 'no-store' }).then(function (response) {
                if (response.ok) {
                    response.json().then(function (novoRegistro) {

                        console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                        console.log(`Dados atuais do gráfico:`);
                        console.log(dados);
                        
                        
                        if (novoRegistro[0].horario == dados.labels[dados.labels.length - 1] && novoRegistro[0].soma == dados.datasets[0].data[dados.datasets[0].data.length-1]) {
                            console.log("---------------------------------------------------------------")
                            console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                            console.log("Horário do novo dado capturado:")
                            console.log(novoRegistro[0].horario)
                            console.log("Horário do último dado capturado:")
                            console.log(dados.labels[dados.labels.length - 1])
                            console.log("---------------------------------------------------------------")
                        } else {
                            for(var i = 0; i<novoRegistro.length;i++){
                                dados.labels.shift(); // apagar o primeiro
                            dados.labels.push(novoRegistro[i].horario); // incluir um novo momento

                            dados.datasets[i].data.shift();  // apagar o primeiro de umidade
                            dados.datasets[i].data.push(novoRegistro[i].soma); // incluir uma nova medida de umidade
                            }    

                            myChart.update();
                        }

                        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                        proximaAtualizacao = setTimeout(() => atualizarGrafico(fkAmbiente, dados, myChart), 2000);
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(fkAmbiente, dados, myChart), 2000);
                }
            })
                .catch(function (error) {
                    console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                });

        }



        function consultarTudo(){
            var fkUser = sessionStorage.ID_USUARIO;
            if (fkUser != null) {
                fetch(`/ambiente/consultaTodos/${fkUser}`, { cache: 'no-store' }).then(function (response) {
                    if (response.ok) {
                        console.log(response)
                        response.json().then(function (novoRegistro) {
                            console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);

                            console.log("Mapa de calor: " + novoRegistro)


                            for (var i = 0; i < qtdeAmb; i++) {
                                fluxoAmbs[i] = 0;
                            }
                            for (var i = 0; i < novoRegistro.length; i++) {
                                for(var h = 0; h<fluxoAmbs.length; h++){
                                    if(novoRegistro[i].idAmbiente == h){
                                        fluxoAmbs[h] += novoRegistro[i].soma;
                                    }
                                }
                                qtdeAmb++;
                            }
                            console.log(fluxoAmbs)
                            for(var i = 0; i < fluxoAmbs.length; i++){
                                document.getElementById("span_qtde_amb"+[i]).innerHTML = fluxoAmbs[i]
                                console.log("quantidade ambiente "+ i + " "+  fluxoAmbs[i])
                            }
                        });
                    } else {
                        console.error('Nenhum dado encontrado ou erro na API');
                        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                        //proximaAtualizacao = setTimeout(() => atualizarGrafico(idSensor, dados, myChart), 2000);
                    }
                })

                    .catch(function (error) {
                        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                    });
            }

        }
        consultarTudo()
    </script>
</body>

</html>
<script>
    var isCollapsed = false;
    // Com lambda
    /*function collapse(collapse_button){
        navbar.style.left = isCollapsed ? '0px' : '-260px';
        collapse_text.style.transform = isCollapsed ? 'rotate(0deg)' : 'rotate(180deg)';
        isCollapsed = !isCollapsed;
    }*/

    // Sem lambda
    function collapse(collapse_button) {
        if (isCollapsed) {
            navbar.style.left = '0px';
            collapse_text.style.transform = 'rotate(0deg)';
            isCollapsed = false;
        } else {
            navbar.style.left = '-260px';
            collapse_text.style.transform = 'rotate(180deg)';
            isCollapsed = true;
        }
    }
</script>